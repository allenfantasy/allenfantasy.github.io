<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 网站统计那些事（三）：统计脚本实现（下） · A Fantasy Ninja</title><meta name="description" content="网站统计那些事（三）：统计脚本实现（下） - Allen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://github.com/allenfantasy" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">网站统计那些事（三）：统计脚本实现（下）</h1><div class="post-meta"><span class="post-time">2017年5月8日</span><span class="taglist"><a href="/tags/JavaScript" class="tag">JavaScript</a><a href="/tags/User Tracking" class="tag">User Tracking</a></span></div><div class="post-content"><p>网站统计系列的第三篇。坑爹的兼容性。<br><a id="more"></a></p>
<p>本篇将继续讨论统计脚本的具体功能实现：</p>
<ul>
<li><a href="#5-统计停留时长">统计停留时长</a></li>
<li><a href="#6-其他细节">其他细节</a></li>
<li><a href="#7-一些小坑">一些小坑</a></li>
</ul>
<p>传送门：</p>
<ul>
<li><a href="../user-tracking-i">网站统计那些事（一）：背景与基础概念</a></li>
<li><a href="../user-tracking-ii">网站统计那些事（二）：统计脚本实现（上）</a></li>
<li><a href="../user-tracking-iv">网站统计那些事（四）：工程化，模块化与测试</a></li>
</ul>
<h2 id="5-统计停留时长"><a href="#5-统计停留时长" class="headerlink" title="5 统计停留时长"></a>5 统计停留时长</h2><p>在<a href="../user-tracking-i#UV-独立访客数">系列的第一篇</a>中我们提到， <code>PV/UV</code> 可以较模糊地反映单个用户对某个页面的黏度，另一个有效反应用户黏度的值就是用户在该页面上的停留时间。在实际开发中，如何计算用户在页面上的停留时间，成为了一个非常复杂的问题。</p>
<h4 id="方案一：头尾相减"><a href="#方案一：头尾相减" class="headerlink" title="方案一：头尾相减"></a>方案一：头尾相减</h4><p>在计算停留时长时，一个简单的思路是使用 ”头尾相减“，即：<code>停留时长 = T(用户离开页面时间点) - T(用户进入页面时间点)</code></p>
<p>这样乍看没有问题，但如果用户实际上 <strong>并没有在看这个页面呢</strong> ？有趣。</p>
<p>用户是有可能不在看这个页面的：</p>
<ul>
<li>用户打开了另外一个标签页</li>
<li>用户打开了另一个应用（或者浏览器被最小化了）</li>
<li>（移动端）用户将浏览器 app 切到了后台，打开了微信</li>
<li>用户只是单纯的走开了…</li>
</ul>
<p>如果需要获取用户 <strong>真正在浏览</strong> 页面时所花的时间，我们不能够单纯的使用头尾相减的方式，因为在这种情况下，以上几种情况都会导致用户的停留时长高的可怕。</p>
<h4 id="方案二：定时心跳"><a href="#方案二：定时心跳" class="headerlink" title="方案二：定时心跳"></a>方案二：定时心跳</h4><p>针对上述提到的几种用户不在浏览页面的情况，ut.js 采用了定时心跳的方法，具体策略如下（为表述方便，以下简称停留时长为 lifetime）：</p>
<ul>
<li>从用户进入页面时，初始化 lifetime 为 0</li>
<li>初始化后，每一个 tick（一个 rAF 的 loop，如果浏览器不支持 rAF 则默认为每 16.67ms）进行一次心跳，每次心跳给 lifetime 加上这次 tick 的时间</li>
<li>在 <strong>用户不在看页面</strong> 时暂停心跳</li>
<li>在 <strong>用户重新看页面</strong> 时重启心跳</li>
<li>在 <strong>用户离开页面</strong> 时，直接上报 lifetime 的值</li>
</ul>
<p>看上去这样的策略没问题，只要我们知道在 JS 中如何得知用户并不在看当前的页面。</p>
<h4 id="Page-Visibility-API"><a href="#Page-Visibility-API" class="headerlink" title="Page Visibility API"></a>Page Visibility API</h4><p>考虑用户在看另一个标签页或者使用另一个程序的情况，使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API" target="_blank" rel="noopener">Page Visibility API</a>：</p>
<blockquote>
<p>The Page Visibility API lets you know when a webpage is visible or in focus.</p>
</blockquote>
<p>在浏览器的页面发生切换的时候，Page Visibility API 会触发一个 <code>visibilitychange</code> 的事件，通过监听这个事件，我们可以动态的控制 lifetime 的心跳：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Set the name of the hidden property and the change event for visibility</span></div><div class="line"><span class="keyword">var</span> hidden, visibilityChange;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">document</span>.hidden !== <span class="string">"undefined"</span>) &#123; <span class="comment">// Opera 12.10 and Firefox 18 and later support</span></div><div class="line">  hidden = <span class="string">"hidden"</span>;</div><div class="line">  visibilityChange = <span class="string">"visibilitychange"</span>;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">document</span>.msHidden !== <span class="string">"undefined"</span>) &#123;</div><div class="line">  hidden = <span class="string">"msHidden"</span>;</div><div class="line">  visibilityChange = <span class="string">"msvisibilitychange"</span>;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">document</span>.webkitHidden !== <span class="string">"undefined"</span>) &#123;</div><div class="line">  hidden = <span class="string">"webkitHidden"</span>;</div><div class="line">  visibilityChange = <span class="string">"webkitvisibilitychange"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleVisibilityChange</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">document</span>[hidden]) &#123;</div><div class="line">    <span class="comment">// 停止心跳...</span></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 启动心跳...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Handle page visibility change</span></div><div class="line"><span class="built_in">document</span>.addEventListener(visibilityChange, handleVisibilityChange, <span class="literal">false</span>);</div></pre></td></tr></table></figure>
<p>找到这个之后我满心欢喜，直到看到了兼容性部分：</p>
<p><img src="/images/page-visibility-api-compatible-table.png" alt=""></p>
<p>这不得不让我们寻求其他解决方案。</p>
<p><img src="/images/no-fuck-say.jpeg" alt=""></p>
<h4 id="文档的-focus-事件"><a href="#文档的-focus-事件" class="headerlink" title="文档的 focus 事件"></a>文档的 focus 事件</h4><p>我们可以监听网页的 <code>focus</code> 事件，来判断用户当前是否在使用这个标签页。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onFocus</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// 启动心跳...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onBlur</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// 停止心跳...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="string">'onfocusin'</span> <span class="keyword">in</span> <span class="built_in">document</span>) &#123;</div><div class="line">  <span class="built_in">document</span>.onfocusin = onFocus;</div><div class="line">  <span class="built_in">document</span>.onfocusout = onBlur;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">window</span>.onfocus = onFocus;</div><div class="line">  <span class="built_in">window</span>.onblur = onBlur;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/focusin" target="_blank" rel="noopener">focusin</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/focusout" target="_blank" rel="noopener">focusout</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/focus" target="_blank" rel="noopener">focus</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/blur" target="_blank" rel="noopener">blur</a></li>
</ul>
<p>为什么不直接使用 <code>window.onfocus</code> 或者 <code>window.onblur</code> ? 因为 <a href="http://stackoverflow.com/a/3745804/1301194" target="_blank" rel="noopener">出现了兼容性问题</a>：</p>
<blockquote>
<p>onfocus and onblur are buggy on the window object in IE. The alternative is to use the propagating onfocusin and onfocusout events</p>
</blockquote>
<p>注意，这里不可以使用 <code>document</code> 对象的 focus 和 blur 事件，因为这两个事件是不冒泡的。</p>
<h4 id="如果用户只是单纯的走开了呢…"><a href="#如果用户只是单纯的走开了呢…" class="headerlink" title="如果用户只是单纯的走开了呢…?"></a>如果用户只是单纯的走开了呢…?</h4><p>这里的根本问题是：</p>
<blockquote>
<p>用户所在的页面一直处于 focus 的状态，而我们无法得知用户是否在 <strong>真正浏览</strong> 这个页面。</p>
</blockquote>
<p>为了解决这个问题，我们对用户的行为给出了一个关键假设：</p>
<blockquote>
<p>如果用户一直在浏览某个页面，那么他必须会在一定时间内对这个页面进行一定的操作（不管是何种类型的操作）。</p>
</blockquote>
<p>基于假设，我们设计了以下策略：</p>
<ol>
<li>设置一个变量 <code>inactiveTime</code>，记录用户不活跃的时间，初始值 为 0</li>
<li>在每一次心跳中累积 <code>inactiveTime</code>，增加该次心跳的时间</li>
<li>如果用户在页面上产生了操作（mousemove, click, touchstart），则重置 <code>inactiveTime</code> 为 0</li>
<li>当 <code>inactiveTime</code> 的累计时间超过一个阈值时，停止心跳。</li>
</ol>
<p>这个策略保证了在用户离开设备的一段时间内，单个页面的 lifetime 累积的最大值不会超过我们所设定的阈值。</p>
<p>在 ut.js 中我们将这个阈值设为了 <strong>20s</strong> —— 这个数字是没有科学依据的，仅仅是作者对于用户浏览一个屏幕内页面内容所需时间的一个估计。</p>
<p>这个策略也无法 <strong>精准的估计</strong> lifetime —— 你无法采用某个 JS API 来得知用户是不是看着看着网页然后离开了座位去喝口水。</p>
<h4 id="lifetime-计算的最终实现"><a href="#lifetime-计算的最终实现" class="headerlink" title="lifetime 计算的最终实现"></a>lifetime 计算的最终实现</h4><p>关于 lifetime 的计算到这里就告一段落，ut.js 中最终的实现代码如下（为理解方便做了修改）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// addEvent() 是包装了 `window.addEventListener` 和 `window.attachEvent` 的事件监听函数</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> r = <span class="built_in">window</span>.requestAnimationFrame;</div><div class="line"><span class="keyword">var</span> c = <span class="built_in">window</span>.cancelAnimationFrame;</div><div class="line"><span class="keyword">var</span> h;</div><div class="line"></div><div class="line"><span class="keyword">var</span> lt = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> ltStart;</div><div class="line"><span class="keyword">var</span> inActiveTime;</div><div class="line"><span class="keyword">var</span> inActiveThreshold = <span class="number">2E4</span>;</div><div class="line"></div><div class="line"><span class="comment">// 创建一个心跳闭包，负责向 lifetime 增加累计时间</span></div><div class="line"><span class="keyword">var</span> h = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> timer;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">beat</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">    <span class="keyword">var</span> diff = now - ltStart;</div><div class="line"></div><div class="line">    lt = lt + diff;</div><div class="line">    inActiveTime = inActiveTime + diff;</div><div class="line">    ltStart = now;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (inActiveTime &lt;= inActiveThreshold) &#123;</div><div class="line">      timer = r(beat);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      timer = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">start</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (!timer) &#123;</div><div class="line">        ltStart = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">        timer = r(beat);</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">stop</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (timer) &#123;</div><div class="line">        c(timer);</div><div class="line">        timer = <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onFocus</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  h.start()</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onBlur</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  h.stop();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 在 PC 端使用 focusin / focusout / focus / blur 事件</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'onfocusin'</span> <span class="keyword">in</span> <span class="built_in">document</span>) &#123;</div><div class="line">  <span class="built_in">document</span>.onfocusin = onFocus;</div><div class="line">  <span class="built_in">document</span>.onfocusout = onBlur;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">window</span>.onfocus = onFocus;</div><div class="line">  <span class="built_in">window</span>.onblur = onBlur;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 在移动端使用 Page Visibility API 检查页面是否 active</span></div><div class="line"><span class="keyword">var</span> prefixes = [<span class="string">''</span>, <span class="string">'webkit'</span>, <span class="string">'moz'</span>, <span class="string">'ms'</span>, <span class="string">'o'</span>];</div><div class="line"><span class="keyword">var</span> pf;</div><div class="line"><span class="keyword">var</span> hiddenKey;</div><div class="line"><span class="keyword">var</span> eventKey;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="comment">/* current env is mobile */</span>) &#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; prefixes.length; i++) &#123;</div><div class="line">    pf = prefixes[i];</div><div class="line">    hiddenKey = pf ? (pf + <span class="string">'Hidden'</span>) : <span class="string">'hidden'</span>;</div><div class="line">    <span class="keyword">if</span> (hiddenKey <span class="keyword">in</span> <span class="built_in">document</span>) &#123;</div><div class="line">      eventKey = pf + <span class="string">'visibilitychange'</span>;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (eventKey) &#123;</div><div class="line">    addEvent(<span class="built_in">document</span>, eventKey, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">document</span>[hiddenKey] ? onBlur() : onFocus();</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">inActiveTime = <span class="number">0</span>;</div><div class="line">h.start(); <span class="comment">// 开始计算 lifetime</span></div></pre></td></tr></table></figure>
<h4 id="上报-lifetime-数据"><a href="#上报-lifetime-数据" class="headerlink" title="上报 lifetime 数据"></a>上报 lifetime 数据</h4><p>在用户结束对网页的访问时，此时我们需要上报 lifetime 数据。单独采用 <code>onbeforeunload</code> 或者 <code>onunload</code> 都是不可取的，因为两个事件都有浏览器不支持的情况出现：</p>
<ul>
<li><a href="https://www.quirksmode.org/bugreports/archives/2004/11/load_and_unload.html" target="_blank" rel="noopener">Opera not supporting load and unload events</a></li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=681636" target="_blank" rel="noopener">Mozilla - window.onunload don’t work when is page is in a popup</a></li>
<li><a href="https://webkit.org/blog/516/webkit-page-cache-ii-the-unload-event/" target="_blank" rel="noopener">onunload not working in Safari…</a></li>
</ul>
<p>…这就很吓人了。为了尽可能的实现兼容，保险的做法是对两个事件同时进行监听，只要有一个事件监听到了就上报 lifetime 的数据。具体代码如下（和实际代码有调整）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> leaveReportSent = <span class="literal">false</span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">reportLeave</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (leaveReportSent) &#123; <span class="comment">// 如果已经发送过了就不再发送了</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 上报 lifetime 数据...</span></div><div class="line">  <span class="comment">// 上报其他数据...</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  leaveReportSent = <span class="literal">true</span>;</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="built_in">window</span>.onbeforeunload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  reportLeave();</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">window</span>.onunload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  reportLeave();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>但是，还有一个问题…</p>
<h4 id="移动端的上报-页面到底走了没有？"><a href="#移动端的上报-页面到底走了没有？" class="headerlink" title="移动端的上报 - 页面到底走了没有？"></a>移动端的上报 - 页面到底走了没有？</h4><p>出于节省流量等考虑，目前相当一部分的手机浏览器都采用了页面缓存的策略，在这个策略下，访问过的上一个页面的文档内容并不会被销毁（即使看上去用户已经关闭了页面），而是被放置到了浏览器自带的一个页面缓存中（详见 Webkit 团队的 <a href="https://webkit.org/blog/427/webkit-page-cache-i-the-basics/" target="_blank" rel="noopener">这篇博客</a>）。</p>
<p>在这种情况下，页面将永远不会触发 <code>beforeunload</code> 或者 <code>unload</code> 事件，按照原有的策略，我们无法进行 lifetime 的上报。这样的直接影响就是，在移动端我们永远无法得知用户在页面上的停留时间。</p>
<p>解决这个问题的思路有两个：</p>
<ol>
<li>利用 <code>pageshow</code> 和 <code>pagehide</code> 事件，当 <code>pagehide</code> 被触发时，视为用户离开了页面；当 <code>pageshow</code> 触发时，视作用户重新进入了页面</li>
<li>利用 <code>Page Visibility API</code>，在页面隐藏起来时，视为用户离开了页面；否则视作用户重新进入了页面。<a href="https://www.igvita.com/2015/11/20/dont-lose-user-and-app-state-use-page-visibility/" target="_blank" rel="noopener">via Ilya Grigorik</a></li>
</ol>
<p>两种思路在相应事件触发时，都上报 lifetime，并重置所有起始变量。</p>
<p>ut.js 使用了第1种实践，具体代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lt - 前文提到的储存 lifetime 的变量</span></div><div class="line"><span class="comment">// reportEnter() - 进入页面时上报信息的方法</span></div><div class="line"><span class="comment">// reportLeave() - 离开页面时上报 lifetime 及其他内容的方法</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> leaveReportSent = <span class="literal">false</span>;</div><div class="line"><span class="keyword">var</span> enterReportSent = <span class="literal">false</span>;</div><div class="line"></div><div class="line">addEvent(<span class="built_in">window</span>, <span class="string">'pageshow'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (event.persisted) &#123;</div><div class="line">    <span class="comment">// like a new page, reset all related attributes</span></div><div class="line">    leaveReportSent = <span class="literal">false</span>;</div><div class="line">    enterReportSent = <span class="literal">false</span>;</div><div class="line">    lt = <span class="number">0</span>;</div><div class="line"></div><div class="line">    reportEnter();</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">addEvent(<span class="built_in">window</span>, <span class="string">'pagehide'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (event.persisted) &#123;</div><div class="line">    reportLeave();</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="6-其他细节"><a href="#6-其他细节" class="headerlink" title="6 其他细节"></a>6 其他细节</h2><ul>
<li>使用了 <code>try ... catch</code> 进行处理错误捕获</li>
<li>暴露一个 <code>hd()</code> 的全局方法，让业务方使用该方法进行 <strong>自定义的上报</strong> ，这一点和 GA 以及百度统计的实现是类似的。</li>
<li>自定义一个 <code>addEvent()</code> 方法封装了 <code>attachEvent</code> 和 <code>addEventListener</code></li>
<li><strong>防止业务方重复加载执行该脚本</strong>：设置一个全局变量作为判定标识</li>
<li>获取额外的设备信息：<ul>
<li>屏幕颜色深度：<code>window.screen.colorDepth</code></li>
<li>屏幕尺寸：<code>window.screen.width</code>,<code>window.screen.height</code></li>
<li>Flash 版本：<code>window.ActiveXObject</code>（随着 Flash 逐渐被淘汰，考虑去掉这个支持）</li>
<li>Cookie：<code>navigator.cookieEnabled</code></li>
<li>Java 支持：<code>navigator.javaEnabled()</code></li>
<li>系统语言：<code>navigator.language</code></li>
</ul>
</li>
</ul>
<h2 id="7-一些小坑"><a href="#7-一些小坑" class="headerlink" title="7 一些小坑"></a>7 一些小坑</h2><h4 id="IE-中使用-console-对象"><a href="#IE-中使用-console-对象" class="headerlink" title="IE 中使用 console 对象"></a>IE 中使用 <code>console</code> 对象</h4><p>在脚本部署逐步上线使用的过程中，<code>console</code> 对象是调试时的一个重要方法，但当实际上线时，我们惊讶地发现正是 <code>console</code> 引起了一些额外的问题：</p>
<ul>
<li>旧版的 IE 中 <code>window</code> 对象并没有 <code>console</code> 属性，</li>
<li>即便有 <code>console</code> 属性，直接使用 <code>console</code> 关键字并不能生效。</li>
</ul>
<p>当然，解决方案是很简单的，写一个简易的 polyfill 即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.console) &#123;</div><div class="line">  <span class="keyword">var</span> <span class="built_in">console</span> = &#123;&#125;;</div><div class="line">  <span class="built_in">console</span>.log = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">  <span class="built_in">console</span>.dir = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> obj) &#123;</div><div class="line">        <span class="built_in">console</span>.log(i + <span class="string">" "</span>, obj[i]);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  <span class="built_in">window</span>.console = <span class="built_in">console</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.console.dir) &#123;</div><div class="line">  <span class="built_in">window</span>.console.dir = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> obj) &#123;</div><div class="line">      <span class="built_in">window</span>.console.log(i + <span class="string">" "</span>, obj[i]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 如果希望在后续的代码中使用 console 关键字</span></div><div class="line"><span class="keyword">var</span> <span class="built_in">console</span> = <span class="built_in">window</span>.console;</div></pre></td></tr></table></figure>
<h4 id="360-浏览器在大部分情况下无法检测"><a href="#360-浏览器在大部分情况下无法检测" class="headerlink" title="360 浏览器在大部分情况下无法检测"></a>360 浏览器在大部分情况下无法检测</h4><ul>
<li>援引 <a href="http://tongji.baidu.com/data/browser" target="_blank" rel="noopener">百度统计</a></li>
</ul>
<blockquote>
<p>奇虎360浏览器份额在2010年10月至2011年3月，和2012年9月以来，两次大幅下降，是因为360浏览器去掉了原本的浏览器特征（User-Agent），而表现为IE等浏览器特征所致。</p>
</blockquote>
<ul>
<li><a href="https://github.com/hotoo/detector/issues/6" target="_blank" rel="noopener">detector 包作者的分析</a></li>
<li><a href="http://bbs.csdn.net/topics/390212770#post-394546176" target="_blank" rel="noopener">某位网友的分析, 指出偏方只能够在 360.cn 上起作用</a></li>
<li>Cnzz 之所以能够检测是因为 360 浏览器内核在 cnzz 的域名下的 userAgent 会带有 360SE/EE 标记，在别的域名下不会…<br>详见 <a href="https://www.zhihu.com/question/20556578/answer/15472681" target="_blank" rel="noopener">知乎上的回答</a></li>
</ul>
<h2 id="RECAP"><a href="#RECAP" class="headerlink" title="RECAP"></a>RECAP</h2><p>到这里我们完成了统计脚本实现细节的归纳。下一篇会着重关注具体的工程化实践，以及如何进行测试以保证质量。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/05/08/user-tracking-iv/" class="prev">上一篇</a><a href="/2017/05/08/user-tracking-ii/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
    this.page.url = 'http://afantasy.ninja/2017/05/08/user-tracking-iii/';
    // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = '2017/05/08/user-tracking-iii/';
    // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://afantasy-ninja.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the<a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a></noscript><script id="dsq-count-scr" src="//afantasy-ninja.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://afantasy.ninja">Allen</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="https://s22.cnzz.com/z_stat.php?id=1261988857&amp;web_id=1261988857"></script><script>document.querySelector('[title="站长统计"]').style.display = 'none'</script></body></html>