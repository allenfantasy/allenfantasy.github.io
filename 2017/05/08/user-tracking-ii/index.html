<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 网站统计那些事（二）：统计脚本实现（上） · A Fantasy Ninja</title><meta name="description" content="网站统计那些事（二）：统计脚本实现（上） - Allen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://github.com/allenfantasy" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">网站统计那些事（二）：统计脚本实现（上）</h1><div class="post-meta"><span class="post-time">2017年5月8日</span><span class="taglist"><a href="/tags/JavaScript" class="tag">JavaScript</a><a href="/tags/User Tracking" class="tag">User Tracking</a></span></div><div class="post-content"><p>网站统计系列的第二篇。一箩筐辣鸡代码和絮絮叨叨。<br><a id="more"></a></p>
<p>在这一篇中，我们将详细讨论如何从业务实际需求出发，实现一个网站统计脚本。由于涉及细节众多，将分为上下两篇来详述。<strong>为了表述方便，下文我们用 ut.js 来代指统计脚本。</strong></p>
<p>在 ut.js 的实际开发中，我们参考了相当部分的 GA 和百度统计的代码，在此特别致谢。</p>
<p>传送门：</p>
<ul>
<li><a href="../user-tracking-i">网站统计那些事（一）：背景与基础概念</a></li>
<li><a href="../user-tracking-iii">网站统计那些事（三）：统计脚本实现（下）</a></li>
<li><a href="../user-tracking-iv">网站统计那些事（四）：工程化，模块化与测试</a></li>
</ul>
<h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><p>本篇将讨论到的实现要点：</p>
<ul>
<li><a href="#1-获取用户的唯一标识">获取用户的唯一标识</a></li>
<li><a href="#2-如何进行上报">如何进行上报</a></li>
<li><a href="#3-获取设备信息">获取设备信息</a></li>
<li><a href="#4-获取用户点击信息">获取用户点击信息</a></li>
</ul>
<h2 id="1-获取用户的唯一标识"><a href="#1-获取用户的唯一标识" class="headerlink" title="1 获取用户的唯一标识"></a>1 获取用户的唯一标识</h2><p>采用 cookie 加随机数的方法生成。这里值得一提的是关于 cookie 的设定。以 <code>www.baidu.com</code><br> 为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 随机生成的一个 100 年后才过期的，支持 *.baidu.com 的 cookie</span></div><div class="line"><span class="built_in">document</span>.cookie = <span class="string">'ui_token=[generated_random_ui_token]; expires=2117-04-10T07:08:33.000Z; domain=.baidu.com'</span></div></pre></td></tr></table></figure>
<p>注意处理 <code>domain</code> 的值是 <code>.baidu.com</code>，这样可以保证在同域名下的其他二级域名中，根据 ui token 识别同一个用户，对于同一主域名下的多个站点统计，这是关键的一步。而 <code>expires</code> 字段表明了这个 cookie 在足够长的时间内不会过期。</p>
<h2 id="2-如何进行上报"><a href="#2-如何进行上报" class="headerlink" title="2 如何进行上报"></a>2 如何进行上报</h2><p>和已有的几家服务商一样，ut.js 采用了 <code>Image src</code> 的上报方式，具体代码如下（为了方便理解，做了部分修改及添加了注释）:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IP_LIST: 备用服务器的 IP 列表</span></div><div class="line"><span class="comment">// REPORT_URL: 服务器的域名地址</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// 上报数据</span></div><div class="line"><span class="comment">// @param  &#123;String&#125; logType 上报日志的类型</span></div><div class="line"><span class="comment">// @param  &#123;Object&#125; data    上报的数据内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">logType, data</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> queryArr = [];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> data) &#123;</div><div class="line">      queryArr.push(<span class="built_in">encodeURIComponent</span>(key) + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(data[key]));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> queryString = queryArr.join(<span class="string">'&amp;'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">var</span> uniqueId = <span class="string">"log_"</span>+ (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime();</div><div class="line">    <span class="keyword">var</span> image = <span class="keyword">new</span> Image(<span class="number">1</span>,<span class="number">1</span>);</div><div class="line">    <span class="built_in">window</span>[uniqueId] = image;   <span class="comment">// use global pointer to prevent unexpected GC</span></div><div class="line"></div><div class="line">    <span class="comment">// 如果使用服务器的域名地址上报失败，则随机使用一个备用 IP 列表中的服务器进行上报</span></div><div class="line">    image.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> ip = IP_LIST[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * IP_LIST.length)];</div><div class="line">      image.src = <span class="built_in">window</span>.location.protocol + <span class="string">'//'</span> + ip + <span class="string">'/j.gif?act='</span> + logType + <span class="string">'&amp;'</span> + queryString;</div><div class="line">      image.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">window</span>[uniqueId] = <span class="literal">null</span>;  <span class="comment">// release global pointer</span></div><div class="line">      &#125;;</div><div class="line">    &#125;;</div><div class="line">    image.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">window</span>[uniqueId] = <span class="literal">null</span>; <span class="comment">// release global pointer</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    image.src = REPORT_URL + <span class="string">'?act='</span> + logType + <span class="string">'&amp;'</span> + queryString;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过动态生成一个 <code>Image()</code> 对象的方法的好处在于不会影响用户的正常使用（完全不可知），同时省去了使用 Ajax 的各种麻烦。但为什么要将新建的 Image 对象赋值给一个 <code>window</code> 对象下的属性呢？原因是在于浏览器的垃圾回收机制会积极地回收这个 Image 对象，且回收的时机很可能在 Image 根据 src 的值发起请求之前，这就导致了上报请求并没有发出。</p>
<p>但为什么浏览器垃圾回收会如此的主动呢？这就和具体的站点情况有关：</p>
<blockquote>
<p>因为一个大脚本的运行回产生大量的“垃圾”，浏览器垃圾回收也会相应地更频繁的启动，从而造成LOG数据丢失</p>
</blockquote>
<p>具体的分析和测试可以参考百度开发童鞋的<a href="http://blog.csdn.net/fudesign2008/article/details/6772108" target="_blank" rel="noopener">这篇博客</a></p>
<h2 id="3-获取设备信息"><a href="#3-获取设备信息" class="headerlink" title="3 获取设备信息"></a>3 获取设备信息</h2><p>获取设备信息是 ut.js 的关键 - 新的设备乃至操作系统层出不穷，国内设备厂商及浏览器厂商众多，要写好一个足够好的脚本能够准确判别信息非常不易。这也是开发中的一个痛点。</p>
<p>通过 JS，我们唯一能够获取设备信息的来源就是 <code>navigator.userAgent</code>，所以这里的问题又集中到了两点：</p>
<ol>
<li>能否写出一个有效的检测方法，从 userAgent 准确地获取设备信息（包括：设备类型，型号，操作系统类型及版本，浏览器类型及版本）？</li>
<li>能否有效地建立 userAgent 库，以满足后续的测试及维护？</li>
</ol>
<p>关于第1点，鉴于这是一个非常广泛的需求，所以我们先从 browser detection 相关的第三方库入手：</p>
<ul>
<li><a href="https://github.com/ded/bowser" target="_blank" rel="noopener">ded/bowser</a></li>
<li><a href="https://github.com/3rd-Eden/useragent" target="_blank" rel="noopener">3rd-Eden/useragent</a></li>
<li><a href="https://github.com/piwik/device-detector" target="_blank" rel="noopener">piwik/device-detector</a></li>
<li><a href="https://github.com/hgoebl/mobile-detect.js/blob/master/mobile-detect.js" target="_blank" rel="noopener">mobile-detect.js</a></li>
<li><a href="https://github.com/zsxsoft/useragent.js" target="_blank" rel="noopener">zsxsoft/useragent.js</a></li>
<li><a href="https://github.com/hotoo/detector" target="_blank" rel="noopener">hotoo/detector</a></li>
</ul>
<p>经过了仔细调研之后，最后决定使用 <a href="https://github.com/hotoo/detector" target="_blank" rel="noopener">hotoo/detector</a> 有几个原因：</p>
<ol>
<li>完善的文档，测试和例子</li>
<li>由支付宝的 @闲耘 维护，大厂使用还是有一定保障（只要他们在一直用这个库，那么我们就不用担心这个库被抛弃掉的问题）</li>
<li>符合国情（并没有找到国人写的比这个更好的一个包）</li>
</ol>
<p>具体的做法就是在开发中引入对 <code>detector</code> 的依赖（代码有部分改动，便于阅读）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> detector = <span class="built_in">require</span>(<span class="string">'detector'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOS</span>(<span class="params">ua</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> os = detector.parse(ua).os;</div><div class="line">  <span class="keyword">var</span> osName = os.name;</div><div class="line">  <span class="keyword">var</span> osVer = os.fullVersion;</div><div class="line"></div><div class="line">  <span class="comment">//========================</span></div><div class="line">  <span class="comment">// 特定的一些自定义处理</span></div><div class="line">  <span class="comment">// 修改格式, 补充遗漏部分等</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">//========================</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> osName + <span class="string">'|'</span> + osVer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBrowser</span>(<span class="params">ua</span>) </span>&#123;</div><div class="line">  <span class="comment">//========================</span></div><div class="line">  <span class="comment">// 对 ua 进行预处理，识别具有明显特征但不在 detector 检测范围内的浏览器 vendor</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">//========================</span></div><div class="line"></div><div class="line">  <span class="keyword">var</span> bs = detector.parse(ua).browser;</div><div class="line">  <span class="keyword">var</span> bsName = bs.name;</div><div class="line">  <span class="keyword">var</span> bsVersion = bs.fullVersion;</div><div class="line"></div><div class="line">  <span class="comment">//========================</span></div><div class="line">  <span class="comment">// 特定的一些自定义处理</span></div><div class="line">  <span class="comment">// 修改格式, 补充遗漏部分等</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">//========================</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> bsName + <span class="string">'|'</span> + bsVer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 对设备类型的检测类似，不赘述</span></div></pre></td></tr></table></figure>
<p>关于第2点，我们在后续的系列文章中再详述。</p>
<h2 id="4-获取用户点击信息"><a href="#4-获取用户点击信息" class="headerlink" title="4 获取用户点击信息"></a>4 获取用户点击信息</h2><p>为了后续获取数据的方便，以及了解用户在页面上的点击分布，ut.js 监听了用户点击的事件，以获取相应的信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// addEvent - 包装了 attachEvent 和 addEventListener 的监听事件函数</span></div><div class="line"><span class="comment">// isLink - 判断某个 DOM 元素是否为 &lt;a&gt; 元素</span></div><div class="line"><span class="comment">// data - 储存用户信息的对象</span></div><div class="line"><span class="comment">// data.ot - 用户离开页面时点击的目标 url</span></div><div class="line"><span class="comment">// data.xy - 用户最后一次点击时的坐标地址</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">captureLink</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> elem = e.target || e.srcElement;</div><div class="line">  <span class="keyword">if</span> (isLink(elem)) &#123;</div><div class="line">    data.ot = elem.href;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// update the x,y of the last link click</span></div><div class="line">  data.xy = e.clientX + <span class="string">','</span> + e.clientY;</div><div class="line">&#125;</div><div class="line"></div><div class="line">addEvent(<span class="built_in">document</span>, <span class="string">'click'</span>, captureLink, <span class="literal">true</span>);</div></pre></td></tr></table></figure>
<p>在下篇中，我们会集中讨论如何获取 <strong>页面停留时间</strong> 这个复杂的问题，以及其他一些技术实现的要点。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/05/08/user-tracking-iii/" class="prev">上一篇</a><a href="/2017/05/08/user-tracking-i/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
    this.page.url = 'http://afantasy.ninja/2017/05/08/user-tracking-ii/';
    // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = '2017/05/08/user-tracking-ii/';
    // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://afantasy-ninja.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the<a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a></noscript><script id="dsq-count-scr" src="//afantasy-ninja.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="http://afantasy.ninja">Allen</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="https://s22.cnzz.com/z_stat.php?id=1261988857&amp;web_id=1261988857"></script><script>document.querySelector('[title="站长统计"]').style.display = 'none'</script></body></html>