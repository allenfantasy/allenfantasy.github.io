<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 网站统计那些事（四）：工程化，模块化与测试 · A Fantasy Ninja</title><meta name="description" content="网站统计那些事（四）：工程化，模块化与测试 - Allen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://github.com/allenfantasy" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">网站统计那些事（四）：工程化，模块化与测试</h1><div class="post-meta"><span class="post-time">2017年5月8日</span><span class="taglist"><a href="/tags/JavaScript" class="tag">JavaScript</a><a href="/tags/User Tracking" class="tag">User Tracking</a></span></div><div class="post-content"><p>网站统计系列的第四篇。没有代码。最后一篇了。<br><a id="more"></a></p>
<p>完全没想到我可以就这个话题写四篇又长又臭的文章…万幸这是最后一篇了 —— 简单介绍项目开发的工程化实践以及如何进行测试。</p>
<p>传送门：</p>
<ul>
<li><a href="../user-tracking-i">网站统计那些事（一）：背景与基础概念</a></li>
<li><a href="../user-tracking-ii">网站统计那些事（二）：统计脚本实现（上）</a></li>
<li><a href="../user-tracking-iii">网站统计那些事（三）：统计脚本实现（下）</a></li>
</ul>
<h2 id="工程化-amp-模块化"><a href="#工程化-amp-模块化" class="headerlink" title="工程化 &amp; 模块化"></a>工程化 &amp; 模块化</h2><p>在公司旧统计脚本的项目中，缺乏对整个工程的任务管理。对此，我们在项目中设计了较完整的工程以及开发流程。目录结构如下：</p>
<p><img src="/images/hiidojs-code-structure.png" alt=""></p>
<ul>
<li><code>dist/</code> - 编译得到的生产环境下的脚本</li>
<li><code>src/</code> - 项目源代码</li>
<li><code>doc/</code> - 文档</li>
<li><del><code>mtq/</code> - <em>@deprecated</em> 无用文件</del></li>
<li><del><code>others/</code> - <em>@deprecated</em> 参考用的文件</del></li>
<li><code>test/</code> - 单元测试代码</li>
<li><code>vendor/</code> - 页面测试使用的第三方的测试库</li>
</ul>
<p>由于我们采用了模块化开发，且依赖于 <a href="https://github.com/hotoo/detector" target="_blank" rel="noopener">detector</a>，所以我们采用 webpack 将 <code>src/</code> 中的代码编译到 <code>dist/</code> 中。又由于 <a href="https://github.com/hotoo/detector" target="_blank" rel="noopener">detector</a> 的源码采用 ES6 语法，所以我们加入了 <code>babel-loader</code>，同时为了在 IE8 及以下的版本中顺利通过，我们采用了 babel 提供的 <a href="https://github.com/bkonkle/babel-preset-es2015-loose" target="_blank" rel="noopener">loose-mode</a></p>
<p>开发中使用的任务用 Gulp 管理，采用 ESLint 进行代码检查。</p>
<p>重新审视公司的旧统计脚本的项目，另一个严重的问题就是，各个功能之间的代码全部混在一个文件里，对于后续维护来说非常的痛苦，同时也无法享受到直接引用第三方库的便利。我们采用了 CommonJS 模块化开发的方式。</p>
<p>在接下来的工作中，我们会采用 ES6 语法对代码进行重写，同时考虑用 <a href="https://github.com/lukehoban/es6features#modules" target="_blank" rel="noopener">ES Modules</a> 取代原有的 CommonJS 模式。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为了保证统计脚本统计结果的准确性，以及具备良好的兼容性，我们在本地架设了完整的测试。</p>
<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><p>在 <a href="../user-tracking-ii#3-获取设备信息">获取设备信息</a> 中我们提到过，为了提高代码的可持续维护，建立一套测试机制以及可维护的 userAgent 库是很有必要的。在模块化的基础上，我们使用 <a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a> 建立了针对设备信息检测的单元测试。以下是一段真实的测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</div><div class="line"><span class="keyword">var</span> osFixtures = <span class="built_in">require</span>(<span class="string">'./fixtures/devices'</span>);</div><div class="line"></div><div class="line">describe(<span class="string">'操作系统'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  _.forEach(osFixtures, <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> desc = f.name + <span class="string">': '</span> + f.key + <span class="string">'|'</span>;</div><div class="line">    <span class="keyword">if</span> (f.key === <span class="string">'linux'</span>) &#123;</div><div class="line">      desc += <span class="string">'[发行版]'</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      desc += <span class="string">'[版本号]'</span>;</div><div class="line">    &#125;</div><div class="line">    describe(desc, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      _.forEach(f.cases, <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123;</div><div class="line">        it(c[<span class="number">0</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">var</span> ret = detector(c[<span class="number">0</span>]);</div><div class="line">          assert.equal(ret.os, c[<span class="number">1</span>].os);</div><div class="line">        &#125;)</div><div class="line">      &#125;);</div><div class="line">    &#125;)</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在测试代码中引用的 <code>./fixtures/devices</code> 就是一个记录了近百条 userAgent 及其真实的设备信息（包括 OS 和浏览器）的 <strong>json 文件</strong></p>
<p>在开发前期，我们从以下几个来源获取 userAgent：</p>
<ul>
<li><a href="http://www.useragentstring.com/pages/useragentstring.php" target="_blank" rel="noopener">UserAgentString</a></li>
<li><a href="http://www.fynas.com/ua" target="_blank" rel="noopener">fynas.com</a></li>
<li><a href="http://www.xuebuyuan.com/885759.html" target="_blank" rel="noopener">各种手机的 User-Agent</a></li>
<li>部分杂牌浏览器：<ul>
<li><a href="http://blog.zsxsoft.com/post/4" target="_blank" rel="noopener">115</a></li>
<li><a href="http://www.cnblogs.com/qq21270/p/3799124.html" target="_blank" rel="noopener">2345</a></li>
<li><a href="https://github.com/hotoo/detector/issues/71" target="_blank" rel="noopener">userAgent string - 其中含百度盒子</a></li>
<li><a href="http://www.webapps-online.com/online-tools/user-agent-strings/dv/browser581791/baidu-spark-browser" target="_blank" rel="noopener">Baidu Spark</a></li>
<li><a href="http://blog.csdn.net/ccclll1990/article/details/17006159" target="_blank" rel="noopener">Baidu Spark II</a></li>
<li><a href="https://www.aqtronix.com/useragents/?Action=ShowAgentDetails&amp;Name=F1Browser+Yunhai+Browser" target="_blank" rel="noopener">Yunhai / F1浏览器</a></li>
<li><a href="http://blog.csdn.net/ccclll1990/article/details/17006159" target="_blank" rel="noopener">海豚浏览器</a></li>
<li><a href="http://liulanmi.com/dl/10230.html/comment-page-2" target="_blank" rel="noopener">旗鱼浏览器</a></li>
<li><a href="https://github.com/hotoo/detector/issues/45" target="_blank" rel="noopener">hotoo/detector: 用户份额大于 0.01% 的客户端 ua 信息</a></li>
</ul>
</li>
</ul>
<p>在系统获取了一批 userAgent 后，我们根据预上线测试阶段所搜集到设备信息为空的请求日志，进行分析后又加入了一批新的 userAgent，而所有在 <code>./test/fixtures</code> 中的测试用例，我们都通过测试的方式进行覆盖并保证其输出是我们预期的结果。</p>
<h4 id="E2E-测试"><a href="#E2E-测试" class="headerlink" title="E2E 测试"></a>E2E 测试</h4><p>由于 ut.js 的实际使用场景将会是线上的各个站点，所以在发布之前，我们必须在本地进行 E2E 测试以保证其基本功能能够顺利进行。以下是 E2E 测试的结构图</p>
<p><img src="/images/hiidojs-e2e-test.png" alt=""></p>
<p>在测试中：</p>
<ul>
<li>我们使用 Express 构建一个简单的 Mock Log Server：<ol>
<li>提供一个 log 的 API 地址供 hiido.js 使用，这个 API 地址在测试时代替了 hiido log 服务器集群，因为我们需要了解实际上报的内容；</li>
<li>提供一个路由加载 E2E 测试用的网页</li>
</ol>
</li>
<li>我们使用多个浏览器 Client 打开测试网页，同时页面上加载了 hiido.js 的代码</li>
<li>根据测试的具体需要，我们 <strong>像真实用户一样操作</strong> 并观察实际上报的数据内容是否符合预期，具体的数据内容由 Mock Log Server 输出到终端或者保存到日志。</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2017/08/21/electron-first-glance/" class="prev">上一篇</a><a href="/2017/05/08/user-tracking-iii/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
    this.page.url = 'http://afantasy.ninja/2017/05/08/user-tracking-iv/';
    // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = '2017/05/08/user-tracking-iv/';
    // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://afantasy-ninja.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the<a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a></noscript><script id="dsq-count-scr" src="//afantasy-ninja.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://afantasy.ninja">Allen</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="https://s22.cnzz.com/z_stat.php?id=1261988857&amp;web_id=1261988857"></script><script>document.querySelector('[title="站长统计"]').style.display = 'none'</script></body></html>